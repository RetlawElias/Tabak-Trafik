<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="UTF-8">
        <title>Die Tabaktrafik</title>
        <style>
            body {
                margin: 0px;
            }

            canvas {
                margin: 0px;
                padding: 0px;
            }
        </style>
    </head>
    <body onload="startGame()">
        <img src="Textures/Upgrade_x640.png" alt="null" hidden="true" id="Upgrade">
        <img src="Textures/Tabak_x640.png" alt="null" hidden="true" id="Cigarettes">
        <img src="Textures/Background_x1280.png" alt="null" hidden="true" id="Background">
        <img src="Textures/Mountains_x1280.png" alt="null" hidden="true" id="Mountains">
        <img src="Textures/Cloudpattern_x5120.png" alt="null" hidden="true" id="Cloudpattern">
        <img src="Textures/Valley_x1280.png" alt="null" hidden="true" id="Valley">
        <img src="Textures/Fabrik_x1280.png" alt="null" hidden="true" id="Fabrik">
        <img src="Textures/Start_x1024.png" alt="null" hidden="true" id="Start">
        <img src="Textures/Bricks.png" alt="null" hidden="true" id="Bricks">
        <img src="Textures/Bricks_Tinted.png" alt="null" hidden="true" id="Bricks_">
        <img src="Textures/Bricks_Tinted_.png" alt="null" hidden="true" id="Bricks__">

        <canvas id="canvas">
        </canvas>

        <script>
            document.addEventListener("mousemove", updateCursorPosition);

            const backgroundDetail = 64;
            const WORLD_WIDTH = 5000;
            const VIEW_WIDTH = canvas.width;
            

            class BackgroundLayer 
            {
                constructor(image, speed, offset = 0, isCloudPattern = false) 
                {
                    this.image = image;
                    this.speed = speed;
                    this.x = offset;
                    this.y = 0;
                    this.isCloudPattern = isCloudPattern;
                }

                update(direction, dt, preGameOffset) 
                {
                    this.x += direction * this.speed * dt;
                    this.y = Math.round(preGameOffset * this.speed * 4 / 4) * 4;
                }

                draw(ctx, canvas) 
                {
                    if(this.isCloudPattern)
                    {
                        ctx.drawImage(this.image,Math.round(this.x * 2),this.y,this.image.width,this.image.height);
                    }
                    else
                    {
                        ctx.drawImage(this.image,Math.round(this.x * 2),this.y,canvas.width * 1.08,canvas.height);
                    }
                }
            }
                


            const camera = {
                x: 0,
                y: 0
            };


            let direction = 1;        // 1 = right, -1 = left
            let range = 20;           // max displacement in pixels
            let baseOffset = 0;
            let startScreenFadingIterator = 0;
            let preGameLoadupIterator = 250;


            var startScreenAnimationIterator = 0;


            let lastTime = performance.now();



            let isDragging = false;
            let clientClick = false;
            
            let lastX = 0;
            let velocityX = 0;    
            


            // Game Variables
            var cigarettes = 0;
            var cigarettesGain = 0;
            
            
            var machineBaseCosts = [10, 30, 100, 250, 1000, 5000, 20000, 100000, 500000, 10000000];
            var machineCostMultipliers = [0,1,1,1,1,1,1,1,1,1];
            
            //UI
            var upgradeButtons = [];






            var gameStarted = false;
            var frame = 0;
            var mousePosition;
            var cursorX;
            var cursorY;
            var ctx;
            var button;
            var button_;
            var startButton;
            

            var TextureButton = document.getElementById("Start");
            var TextureUpgrade = document.getElementById("Upgrade");

            var cigarettesTexture = document.getElementById("Cigarettes");
            var background = document.getElementById("Background");
            var cloudspattern = document.getElementById("Cloudpattern");
            var mountains = document.getElementById("Mountains");
            var valley = document.getElementById("Valley");
            var fabrik = document.getElementById("Fabrik");

            const layers = [
                new BackgroundLayer(background, 0.01, -20),
                new BackgroundLayer(cloudspattern, -30, -20, true),
                new BackgroundLayer(mountains, 0.5, -20),
                new BackgroundLayer(valley, 1, -20),
                new BackgroundLayer(fabrik, 1.5, -45),
            ];


            var bricks = document.getElementById("Bricks");
            var bricks_ = document.getElementById("Bricks_");
            var bricks__ = document.getElementById("Bricks__");

            

            
            camera.x = Math.max(0,Math.min(WORLD_WIDTH - VIEW_WIDTH, camera.x));


            



            
            function startGame() 
            {
                myGameArea.start();

                startButton = new canvasButton(myGameArea.canvas.width / 2 - 250, 100, 500, 250, new canvasButtonTexture(TextureButton));
                startButton.onClick = function()
                {
                    gameStarted = true;
                }
                

                for(let i = 0; i < 10; i++)
                {
                    upgradeButtons[i] = new canvasButton(300 + i * 200, 800, 100, 100, new canvasButtonTexture(TextureUpgrade, "", "Free"));
                

                    upgradeButtons[i].onClick = function()
                    {
                        if(cigarettes >= machineBaseCosts[i] * machineCostMultipliers[i])
                        {
                            cigarettes -= machineBaseCosts[i] * machineCostMultipliers[i];
                            

                            switch(i)
                            {
                                case 0:
                                    if(cigarettesGain == 0)
                                    {
                                        cigarettesGain += 0.01;
                                        machineCostMultipliers[i] += 1;
                                    }
                                    else
                                    {
                                        machineCostMultipliers[i] *= 1.1;
                                    }
                            
                                    cigarettesGain += 0.006;
                                    break;
                                case 1:
                                    cigarettesGain += 0.03;
                                    machineCostMultipliers[i] *= 1.1;
                                    break;
                                case 2:
                                    cigarettesGain += 0.1;
                                    machineCostMultipliers[i] *= 1.1;
                                    break;
                                case 3:
                                    cigarettesGain += 0.25;
                                    machineCostMultipliers[i] *= 1.1;
                                    break;
                                case 4:
                                    cigarettesGain += 0.75;
                                    machineCostMultipliers[i] *= 1.1;
                                    break;
                                case 5:
                                    cigarettesGain += 1.5;
                                    machineCostMultipliers[i] *= 1.1;
                                    break;
                                case 6:
                                    cigarettesGain += 2.5;
                                    machineCostMultipliers[i] *= 1.1;
                                    break;
                                case 7:
                                    cigarettesGain += 4.0;
                                    machineCostMultipliers[i] *= 1.1;
                                    break;
                                case 8:
                                    cigarettesGain += 4.0;
                                    machineCostMultipliers[i] *= 1.1;
                                    break;
                                case 9:
                                    cigarettesGain += 10.0;
                                    machineCostMultipliers[i] *= 1.1;
                                    break;
                            }
                        }
                    }
                }
            }

            function addListenersToCanvas(canvas)
            {

                canvas.addEventListener("pointerdown", e => 
                {
                    isDragging = true;
                    lastX = e.clientX;
                    canvas.setPointerCapture(e.pointerId);
                });
                
                canvas.addEventListener("pointermove", e => 
                {
                    if (!isDragging) return;
                    
                    const dx = e.clientX - lastX;
                    lastX = e.clientX;
                    
                    velocityX = dx;
                    camera.x -= dx;
                });
                
                
                canvas.addEventListener("pointerup", () => 
                {
                    clientClick = true;
                    isDragging = false;
                });
            }

            function addListenersToWindow()
            {
                window.addEventListener('keydown', function (e) 
                {
                    if (e.key === "ArrowDown") 
                    {
                            console.log("pressed");
                    } 
                });
                    
                window.addEventListener('resize', function() 
                {
                    document.getElementById("canvas").width = window.innerWidth - 0;
                    document.getElementById("canvas").height = window.innerHeight - 4;
                    realignGUI();
                });
            }



            var myGameArea = 
            {
                canvas : document.getElementById("canvas"),
                start : function() {
                    this.canvas.width = window.innerWidth - 0;
                    this.canvas.height = window.innerHeight - 4;
                    this.context = this.canvas.getContext("2d");
                    ctx = this.context;
                    document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                    this.frameNo = 0;
                    this.interval = setInterval(updateGameArea, 20);

                    addListenersToCanvas(this.canvas);
                    addListenersToWindow();

                },
                updateSize : function()
                {
                    
                },
                pause : function()
                {
                    clearInterval(this.interval);
                },
                unpause : function() 
                {
                    this.interval = setInterval(updateGameArea, 20);
                },
                stop : function() 
                {
                    clearInterval(this.interval);
                },    
                clear : function() 
                {
                    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }
            }


            function drawObject(obj) 
            {
                ctx.drawImage(obj.image, obj.x - camera.x, obj.y - camera.y);
            }



            function update() 
            {
                if (!isDragging) 
                {
                    velocityX *= 0.92;
                    camera.x -= velocityX;
                }

                // Clamp
                camera.x = Math.max(0, Math.min(WORLD_WIDTH - VIEW_WIDTH, camera.x));
            }   
            



        function drawBackground(ctx)
        {
            //ctx.filter = "saturate(50%)";

            for(let j = 0; j < (WORLD_WIDTH + myGameArea.canvas.width) / backgroundDetail; j++)
            {
                for(let i = 0; i < myGameArea.canvas.height / backgroundDetail; i++)
                {
                    if(i + 1 < myGameArea.canvas.height / backgroundDetail)
                    {
                        if(j == 0 || j + 3 >= (WORLD_WIDTH + myGameArea.canvas.width) / backgroundDetail)
                        {
                            ctx.drawImage(bricks__, backgroundDetail * j, i * backgroundDetail, backgroundDetail, backgroundDetail);
                        }
                        else
                        {
                            ctx.drawImage(bricks, backgroundDetail * j, i * backgroundDetail, backgroundDetail, backgroundDetail);
                        }
                    }
                    else
                    {
                        ctx.drawImage(bricks__, backgroundDetail * j, i * backgroundDetail, backgroundDetail, backgroundDetail);
                    }
                }
            }
        }

        function realignGUI()
        {
            startButton.x = myGameArea.canvas.width / 2 - (myGameArea.canvas.width / 4 / 2);
            startButton.sizeX = myGameArea.canvas.width / 4;
            startButton.sizeY = myGameArea.canvas.height / 4;
        }



        function drawStartButton()
        {


            //Start-Button
            const FadeTiming = 100;
            const MoveTiming = 40;
            

            if(startScreenAnimationIterator % (MoveTiming * 2) < MoveTiming)
                {
                    if(startScreenAnimationIterator % (MoveTiming / 4) == 0)
                    {
                        startButton.y -= 1;
                    }
                }
                else
                {
                    if(startScreenAnimationIterator % (MoveTiming / 4) == 0)
                    {
                        startButton.y += 1;
                    }
                }

            if(!startButton.onClickCheck())
            {

                if(startScreenFadingIterator % (FadeTiming * 2) < FadeTiming)
                {
                    ctx.globalAlpha = (startScreenFadingIterator % FadeTiming) / FadeTiming + 0.3;
                }
                else
                {
                    ctx.globalAlpha = 1 - (startScreenFadingIterator % FadeTiming) / FadeTiming + 0.3;
                }
            }
            else
            {
                startScreenFadingIterator = FadeTiming;
            }
            startButton.drawSelf();
            ctx.globalAlpha = 1;
        }
        


        function updateGameArea()
        {
            const now = performance.now();
            const dt = (now - lastTime) / 1000; // seconds
            
            frame++;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if(!gameStarted)
            {
                
                lastTime = now;
                baseOffset += direction * dt;
                
                
                if (Math.abs(baseOffset) > range) 
                {
                    direction *= -1;
                }
                
                
                
                if(preGameLoadupIterator > 0 && preGameLoadupIterator < 150)
                {
                    preGameLoadupIterator--;
                    layers.forEach(layer => layer.update(direction, dt, preGameLoadupIterator));
                    layers.forEach(layer => layer.draw(ctx, myGameArea.canvas));
                }
                else if(preGameLoadupIterator < 150)
                {
                    startScreenFadingIterator++;
                    layers.forEach(layer => layer.update(direction, dt, preGameLoadupIterator));
                    layers.forEach(layer => layer.draw(ctx, myGameArea.canvas));
                    drawStartButton();
                }
                else
                {
                    layers.forEach(layer => layer.update(direction, dt, 150));
                    layers.forEach(layer => layer.draw(ctx, myGameArea.canvas));
                    preGameLoadupIterator--;
                }
                
                startScreenAnimationIterator++;
                clientClick = false;
                return;
            }
            








            update();

            ctx.clearRect(0, 0, canvas.width, canvas.height);
                
            ctx.save();
            ctx.translate(-camera.x, -camera.y);




            cigarettes += cigarettesGain;


            // Relative to Camera //
                
            drawBackground(ctx);

            drawButtonsAndLabels();
            
            


            // Relative to Camera //
            ctx.restore();
            // Relative to Screen //

            ctx.font = "20px Arial";
            ctx.fillText("Frame: " + frame, 20, 20);
            ctx.fillText(mousePosition, 20, 50);


            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.fillRect(canvas.width / 2 - 100, 0, 200, 100);
            ctx.drawImage(cigarettesTexture, canvas.width / 2 - 100, 5, 50, 50);
            ctx.fillStyle = "rgba(0,0,0,1)";
            ctx.font = "40px Titanic";
            ctx.fillText(Math.floor(cigarettes), canvas.width / 2, 40);


            // Relative to Screen //


            clientClick = false;
        }





        function drawButtonsAndLabels()
        {
            for(let i = 0; i < upgradeButtons.length; i++)
            {
                upgradeButtons[i].buttonTexture.text = Math.ceil(machineBaseCosts[i] * machineCostMultipliers[i]).toString();
                if(upgradeButtons[i].buttonTexture.text == 0)
                {
                    upgradeButtons[i].buttonTexture.text = "Free";
                }

                upgradeButtons[i].drawSelf();
                upgradeButtons[i].onClickCheck();
            }
        }



            function updateCursorPosition(event) 
            {
                cursorX = event.clientX;
                cursorY = event.clientY;
                var positionElement = document.getElementById("mousePosition");

                // Update the body's content to display the cursor position
                mousePosition = "X: " + Math.round(cursorX - 8 + camera.x) + ", Y: " + Math.round(cursorY - 8 + camera.y);
            }

        
        function canvasButtonTexture(texture, color = "", text = "")
        {
            this.texture = texture;
            this.color = color;
            this.text = text;
        }



        function canvasButton(x,y, sizeX, sizeY, buttonTexture, enabled = true)
        {
            this.x = x;
            this.y = y;
            this.sizeX = sizeX;
            this.sizeY = sizeY;
            this.buttonTexture = buttonTexture;
            this.enabled = enabled;
            
            
            this.drawSelf = function()
            {
                if(this.buttonTexture.texture !== "")
                {
                    ctx.drawImage(this.buttonTexture.texture, this.x, this.y, this.sizeX, this.sizeY)
                }
                else
                {
                    ctx.fillStyle = this.buttonTexture.color;
                    ctx.fillRect(this.x, this.y, this.sizeX, this.sizeY);
                }

                if(buttonTexture.text != "")
                {
                    ctx.fillStyle = "black";
                    ctx.font = Math.round(sizeY / 5) + "px Arial";
                    ctx.fillText(buttonTexture.text, this.x + (this.sizeX / 2) - (buttonTexture.text.length * 5), this.y + (this.sizeY / 2))
                }
            }

            this.onClickCheck = function()
            {
                if(cursorX + camera.x >= this.x && cursorX + camera.x <= this.x + this.sizeX &&
                   cursorY >= this.y && cursorY <= this.y + this.sizeY)
                {
                    this.onHover();
                    return true;
                }

                return false;
            }

            this.onHover = function()
            {
                console.log("Hovered the Button");
                if(clientClick)
                {
                    this.onClick();
                }   
            }

            this.onClick = function()
            {
                console.log("Button has been clicked");
                this.color = "rgba("+ Math.floor((Math.random() * 255)) + "," + 
                                      Math.floor((Math.random() * 255)) + "," +
                                      Math.floor((Math.random() * 255)) + "," +
                                      Math.floor((Math.random() * 255)) +")";
                console.log("New Color: " + this.color);
            }
        }      





        

        </script>
    </body>
</html>